<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Galactic Defender - Final Ad Fix</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        :root { --primary: #00ffff; --secondary: #ff0055; --gold: #ffd700; --power: #ff3300; }
        body { margin: 0; padding: 0; background-color: #000; overflow: hidden; font-family: 'Orbitron', sans-serif; touch-action: none; user-select: none; -webkit-user-select: none; }
        canvas { display: block; width: 100%; height: 100%; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .hud-top { display: flex; justify-content: space-between; padding: 15px; color: var(--primary); font-size: 14px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); }
        #bossHud { position: absolute; top: 70px; left: 10%; width: 80%; display: none; animation: slideDown 0.5s ease-out; }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .hp-bar-bg { width: 100%; height: 12px; background: #222; border: 2px solid #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 0 10px var(--secondary); }
        .hp-bar-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #ff0000, #ff8800); transition: width 0.2s; }
        .power-container { margin-top: 5px; font-size: 10px; color: var(--power); }
        .power-bar { display: inline-block; width: 10px; height: 10px; background: #333; margin-right: 2px; border: 1px solid #555; transform: skewX(-20deg); }
        .power-bar.active { background: var(--power); box-shadow: 0 0 5px var(--power); border-color: #fff; }
        #warningScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 0, 0, 0.3); display: none; z-index: 5; animation: flash 0.5s infinite; pointer-events: none; }
        @keyframes flash { 0%, 100% { opacity: 0; } 50% { opacity: 1; } }
        .warning-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: red; font-size: 40px; font-weight: 900; letter-spacing: 5px; text-shadow: 0 0 20px black; border: 5px solid red; padding: 10px 30px; }
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, rgba(10,20,50,0.95) 0%, #000 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: auto; z-index: 20; transition: opacity 0.3s; }
        .hidden { opacity: 0; pointer-events: none; z-index: -1; }
        h1 { font-size: 3rem; color: var(--primary); margin: 0; text-transform: uppercase; letter-spacing: 3px; text-shadow: 0 0 25px var(--primary); text-align: center; }
        .btn { background: linear-gradient(45deg, #004466, #0088aa); border: 2px solid var(--primary); color: #fff; padding: 12px 30px; margin: 10px; font-size: 1.1rem; font-family: inherit; cursor: pointer; border-radius: 8px; width: 250px; text-align: center; text-transform: uppercase; box-shadow: 0 0 15px rgba(0, 255, 255, 0.2); transition: 0.2s; }
        .btn:active { transform: scale(0.95); }
        .btn-ad { background: linear-gradient(45deg, #b8860b, #ffd700); color: #000; font-weight: 900; border-color: #fff; animation: pulseBtn 1.5s infinite; }
        .btn-resume { background: linear-gradient(45deg, #00ff00, #006600); color: #fff; font-weight: bold; border: 2px solid #fff; animation: pulseBtn 1s infinite; }
        @keyframes pulseBtn { 0% { transform: scale(1); box-shadow: 0 0 10px gold; } 50% { transform: scale(1.05); box-shadow: 0 0 25px gold; } 100% { transform: scale(1); box-shadow: 0 0 10px gold; } }
        .grid-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-width: 95%; max-height: 50vh; overflow-y: auto; padding: 10px; }
        .level-box { background: rgba(255,255,255,0.1); border: 1px solid var(--primary); padding: 15px; border-radius: 8px; text-align: center; color: #fff; }
        .level-box.locked { border-color: #555; opacity: 0.3; pointer-events: none; }
        .ship-selector { display: flex; gap: 15px; margin-bottom: 20px; }
        .ship-card { border: 2px solid #444; width: 70px; height: 70px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.6); transition: 0.2s; }
        .ship-card.selected { border-color: var(--secondary); box-shadow: 0 0 20px var(--secondary); transform: scale(1.1); }
        .ship-card img { width: 50px; height: 50px; object-fit: contain; }
        #bombBtn { position: absolute; bottom: 30px; right: 20px; width: 70px; height: 70px; border-radius: 50%; background: rgba(255, 0, 85, 0.9); border: 2px solid #fff; display: none; align-items: center; justify-content: center; font-size: 30px; pointer-events: auto; cursor: pointer; box-shadow: 0 0 20px var(--secondary); z-index: 15; }
        .float-text { position: absolute; color: gold; font-weight: bold; font-size: 14px; pointer-events: none; animation: floatUp 1s forwards; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }
        .setting-row { display: flex; justify-content: space-between; width: 300px; margin: 10px 0; color: white; font-size: 1.1rem; }
        .toggle { cursor: pointer; color: gold; font-weight: bold; }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="ui-layer">
        <div class="hud-top" id="hud" style="display: none;">
            <div>SCORE: <span id="scoreVal">0</span> <br><span style="color:var(--gold)">COINS: <span id="coinVal">0</span></span></div>
            <div style="text-align:center">MISSION <span id="levelVal">1</span><div class="power-container" id="powerUi"><span class="power-bar active"></span><span class="power-bar"></span><span class="power-bar"></span><span class="power-bar"></span></div></div>
            <div style="text-align:right"><div style="color:var(--secondary); font-size:20px; letter-spacing:2px;" id="hpVal">‚ù§‚ù§‚ù§</div><div style="font-size:12px; color:#aaa; margin-top:5px;">TARGET: <span id="taskVal">0/0</span></div></div>
        </div>
        <div id="bossHud"><div style="text-align:center; color:#fff; font-size:12px; margin-bottom:5px;">‚ö† MOTHERSHIP DETECTED ‚ö†</div><div class="hp-bar-bg"><div class="hp-bar-fill" id="bossHpFill"></div></div></div>
        <div id="bombBtn">üí£</div>
        <div id="warningScreen"><div class="warning-text">WARNING</div></div>
    </div>
    <div id="mainMenu" class="screen">
        <h1>GALACTIC<br>DEFENDER</h1>
        <div style="margin: 10px 0; color:#aaa;">PLAY STORE EDITION</div>
        <div class="ship-selector" id="shipSelector"></div>
        <div class="btn" onclick="UI.showLevelSelect()">PLAY GAME</div>
        <div class="btn" onclick="UI.showShop()">ARMORY</div>
        <div class="btn" onclick="UI.showSettings()">SETTINGS</div>
    </div>
    <div id="levelScreen" class="screen hidden"><h2>SELECT MISSION</h2><div class="grid-container" id="levelGrid"></div><div class="btn" onclick="UI.goHome()">BACK</div></div>
    <div id="shopScreen" class="screen hidden"><h2>ARMORY</h2><h3 style="color:gold">BALANCE: $<span id="shopCoins">0</span></h3><div class="grid-container" id="shopItems" style="grid-template-columns: 1fr 1fr;"></div><div class="btn" onclick="UI.goHome()">BACK</div></div>
    <div id="settingScreen" class="screen hidden"><h2>SETTINGS</h2><div class="setting-row"><span>Music</span> <span class="toggle" onclick="Game.toggleAudio('music')" id="optMusic">ON</span></div><div class="setting-row"><span>SFX</span> <span class="toggle" onclick="Game.toggleAudio('sfx')" id="optSfx">ON</span></div><div class="setting-row"><span>Vibration</span> <span class="toggle" onclick="Game.toggleAudio('vibe')" id="optVibe">ON</span></div><div class="btn" onclick="UI.goHome()">BACK</div></div>
    <div id="endScreen" class="screen hidden"><h1 id="endTitle">GAME OVER</h1><h2 id="endScore">Score: 0</h2><div id="endButtons"></div></div>

<script>
// --- ASSETS CONFIG ---
// GitHub URL - Ensure this is correct
const BASE_URL = "https://emdadm511-alt.github.io/galactic-game/";

const ASSETS={bg:BASE_URL+'bg.png',bullet:BASE_URL+'bullet.png',planes:[BASE_URL+'plane1.png',BASE_URL+'plane2.png',BASE_URL+'plane3.png'],enemies:[BASE_URL+'obscle1.png',BASE_URL+'obscle2.png'],bosses:[BASE_URL+'boss1.png',BASE_URL+'boss2.png',BASE_URL+'boss3.png'],sounds:{bgm:BASE_URL+'bgm.wav',shoot:BASE_URL+'bullet.wav',explo:BASE_URL+'explosion.wav'}};
const IMAGES={},AUDIO={};

function loadAssets(){
    ['bg', 'bullet'].forEach(k => { let i=new Image(); i.src=ASSETS[k]; IMAGES[k]=i; });
    ASSETS.planes.forEach((s,i) => { let m=new Image(); m.src=s; IMAGES['plane'+i]=m; });
    ASSETS.enemies.forEach((s,i) => { let m=new Image(); m.src=s; IMAGES['enemy'+i]=m; });
    ASSETS.bosses.forEach((s,i) => { let m=new Image(); m.src=s; IMAGES['boss'+i]=m; });
    AUDIO.bgm=new Audio(ASSETS.sounds.bgm);AUDIO.bgm.loop=true;AUDIO.shoot=new Audio(ASSETS.sounds.shoot);AUDIO.explo=new Audio(ASSETS.sounds.explo);
}

const STORAGE_KEY='galactic_admob_v4';
const RESUME_KEY='galactic_resume_state'; 

const Data={coins:0,maxLevel:1,unlockedShips:[0],selectedShip:0,dmgLvl:1,settings:{music:true,sfx:true,vib:true},load:function(){const s=localStorage.getItem(STORAGE_KEY);if(s)Object.assign(this,JSON.parse(s));},save:function(){localStorage.setItem(STORAGE_KEY,JSON.stringify(this));}};

const cvs=document.getElementById('gameCanvas');const ctx=cvs.getContext('2d',{alpha:false});
let width,height,state='MENU',level=1,score=0,kills=0,targetKills=0,frame=0,shake=0,bomb=1,player,boss=null,bullets=[],enemies=[],particles=[],items=[],stars=[];
const input={x:0,y:0,active:false};

// ENTITIES
class Player{constructor(){this.x=width/2;this.y=height-120;this.w=60;this.h=60;this.hp=3;this.shieldTimer=0;this.lastShot=0;this.powerLevel=1;this.maxPower=4;input.x=this.x;input.y=this.y;}update(){if(input.active){this.x+=(input.x-this.x)*0.15;this.y+=((input.y-60)-this.y)*0.15;}this.x=Math.max(30,Math.min(width-30,this.x));this.y=Math.max(30,Math.min(height-30,this.y));if(state==='PLAY'){let r=this.powerLevel>=4?8:15;if(frame-this.lastShot>r){this.shoot();this.lastShot=frame;}if(this.shieldTimer>0)this.shieldTimer--;}}shoot(){if(Data.settings.sfx&&state==='PLAY'){let s=AUDIO.shoot.cloneNode();s.volume=0.12;s.play().catch(()=>{});}let pm=1+(this.powerLevel-1)*0.5;let d=Data.dmgLvl*pm;if(Data.selectedShip===0){bullets.push({x:this.x,y:this.y-30,vx:0,vy:-12,dmg:d,enemy:false});}else{bullets.push({x:this.x-10,y:this.y-30,vx:0,vy:-12,dmg:d,enemy:false});bullets.push({x:this.x+10,y:this.y-30,vx:0,vy:-12,dmg:d,enemy:false});}if(this.powerLevel>=2){bullets.push({x:this.x-25,y:this.y,vx:-1,vy:-10,dmg:d,enemy:false});bullets.push({x:this.x+25,y:this.y,vx:1,vy:-10,dmg:d,enemy:false});}if(this.powerLevel>=3){bullets.push({x:this.x-35,y:this.y+10,vx:-3,vy:-9,dmg:d,enemy:false});bullets.push({x:this.x+35,y:this.y+10,vx:3,vy:-9,dmg:d,enemy:false});}}draw(){let i=IMAGES['plane'+Data.selectedShip];if(i&&i.complete){ctx.shadowBlur=15;ctx.shadowColor='#00ffff';ctx.drawImage(i,this.x-30,this.y-30,60,60);ctx.shadowBlur=0;}else{ctx.fillStyle='#0ff';ctx.fillRect(this.x-20,this.y-20,40,40);}if(this.shieldTimer>0){ctx.strokeStyle=`rgba(0,255,255,${Math.random()})`;ctx.lineWidth=3;ctx.beginPath();ctx.arc(this.x,this.y,45,0,Math.PI*2);ctx.stroke();}}upgrade(){if(this.powerLevel<this.maxPower){this.powerLevel++;spawnFloatText(this.x,this.y-40,"WEAPON UP!","#ff3300");UI.updatePowerBars();}else{score+=500;spawnFloatText(this.x,this.y-40,"MAX POWER!","#ff3300");}}}
class Enemy{constructor(t){this.x=Math.random()*(width-60)+30;this.y=-50;this.type=t;this.hp=Math.floor(2+(level*0.7));this.w=50;this.h=50;this.age=0;this.imgKey='enemy'+(Math.random()>0.5?0:1);let sm=1+(level*0.05);this.vy=(2+Math.random())*sm;this.vx=(t===1)?(Math.random()<0.5?-2:2)*sm:0;}update(){this.age++;if(this.type===1){this.x+=this.vx;if(this.x<30||this.x>width-30)this.vx*=-1;}this.y+=this.vy;let sp=Math.min(0.03,0.005+(level*0.001));if(Math.random()<sp)bullets.push({x:this.x,y:this.y+25,vx:0,vy:6+(level*0.2),dmg:1,enemy:true});return this.y<height+60;}draw(){let i=IMAGES[this.imgKey];if(i&&i.complete)ctx.drawImage(i,this.x-25,this.y-25,50,50);else{ctx.fillStyle='red';ctx.fillRect(this.x-20,this.y-20,40,40);}}}
class Boss{constructor(l){this.x=width/2;this.y=-150;this.maxHp=300+(l*150);this.hp=this.maxHp;this.dir=1;this.timer=0;let idx=(l-1)%3;this.imgKey='boss'+idx;}update(){if(this.y<200)this.y+=1;else{this.x+=2*this.dir;if(this.x>width-80||this.x<80)this.dir*=-1;this.timer++;let ar=Math.max(30,60-(level*2));if(this.timer%ar===0){let sp=Math.min(3,1+Math.floor(level/5));for(let i=-sp;i<=sp;i++)bullets.push({x:this.x,y:this.y+60,vx:i*1.5,vy:6,dmg:1,enemy:true});}}UI.updateBossHp(this.hp,this.maxHp);}draw(){let i=IMAGES[this.imgKey];if(i&&i.complete)ctx.drawImage(i,this.x-75,this.y-60,150,120);else{ctx.fillStyle='purple';ctx.fillRect(this.x-60,this.y-40,120,80);}}}

function spawnParticles(x,y,c){if(particles.length>50)particles.splice(0,10);for(let i=0;i<6;i++)particles.push({x:x,y:y,vx:(Math.random()-0.5)*10,vy:(Math.random()-0.5)*10,life:1,color:c});}
function spawnFloatText(x,y,t,c){let d=document.createElement('div');d.className='float-text';d.style.left=x+'px';d.style.top=y+'px';d.style.color=c||'gold';d.innerText=t;document.body.appendChild(d);setTimeout(()=>d.remove(),800);}
function distSq(o1,o2){let dx=o1.x-o2.x,dy=o1.y-o2.y;return dx*dx+dy*dy;}

function init(){Data.load();loadAssets();resize();window.addEventListener('resize',resize);setupInput();for(let i=0;i<60;i++)stars.push({x:Math.random()*width,y:Math.random()*height,s:Math.random()*2+0.5});UI.updateShipSelector();
    const resumeData = localStorage.getItem(RESUME_KEY);
    if(resumeData){
        const d=JSON.parse(resumeData);
        if(d.action==='revive'){Game.start(d.level);score=d.score;kills=d.kills;if(player)player.powerLevel=d.power||1;if(d.bossHp!==null){boss=new Boss(d.level);boss.hp=d.bossHp;boss.maxHp=d.bossMax||boss.maxHp;boss.y=200;document.getElementById('bossHud').style.display='block';UI.updateBossHp(boss.hp,boss.maxHp);}Game.revive(true);}
        else if(d.action==='nextLevel'){Game.start(d.level+1);score=d.score;if(player)player.powerLevel=d.power||1;}
        localStorage.removeItem(RESUME_KEY);
    }
    loop();
}
function resize(){width=cvs.width=window.innerWidth;height=cvs.height=window.innerHeight;}
function setupInput(){const s=(e)=>{e.preventDefault();input.active=true;let t=e.touches?e.touches[0]:e;input.x=t.clientX;input.y=t.clientY;};const m=(e)=>{if(input.active){let t=e.touches?e.touches[0]:e;input.x=t.clientX;input.y=t.clientY;}};cvs.addEventListener('touchstart',s,{passive:false});cvs.addEventListener('touchmove',m,{passive:false});cvs.addEventListener('mousedown',s);window.addEventListener('mousemove',m);window.addEventListener('mouseup',()=>input.active=false);}

function loop(){
    requestAnimationFrame(loop);ctx.fillStyle='#000510';ctx.fillRect(0,0,width,height);
    if(IMAGES.bg&&IMAGES.bg.complete){ctx.globalAlpha=0.6;ctx.drawImage(IMAGES.bg,0,0,width,height);ctx.globalAlpha=1;}
    ctx.fillStyle='#fff';stars.forEach(s=>{s.y+=s.s;if(s.y>height)s.y=0;ctx.fillRect(s.x,s.y,s.s,s.s);});
    if(state!=='PLAY')return;
    frame++;if(shake>0){ctx.save();ctx.translate((Math.random()-0.5)*15,(Math.random()-0.5)*15);shake--;}
    player.update();player.draw();
    if(!boss){if(kills>=targetKills){boss=new Boss(level);enemies=[];document.getElementById('bossHud').style.display='block';if(Data.settings.vib)navigator.vibrate([100,50,100]);}else{let sr=Math.min(0.08,0.015+(level*0.003));let me=Math.min(12,4+Math.floor(level/2));if(Math.random()<sr&&enemies.length<me){let t=0;if(level>3&&Math.random()>0.7)t=1;enemies.push(new Enemy(t));}}}else{boss.update();boss.draw();if(distSq(boss,player)<4000)hitPlayer();}
    for(let i=bullets.length-1;i>=0;i--){let b=bullets[i];b.x+=b.vx;b.y+=b.vy;if(b.enemy){ctx.fillStyle='#ff3333';ctx.beginPath();ctx.arc(b.x,b.y,6,0,Math.PI*2);ctx.fill();if(distSq(b,player)<900){hitPlayer();bullets.splice(i,1);}}else{if(IMAGES.bullet&&IMAGES.bullet.complete)ctx.drawImage(IMAGES.bullet,b.x-10,b.y-10,20,35);else{ctx.fillStyle='#0ff';ctx.fillRect(b.x-3,b.y-5,6,15);}let h=false;if(boss&&Math.abs(b.x-boss.x)<70&&Math.abs(b.y-boss.y)<50){boss.hp-=b.dmg;h=true;spawnParticles(b.x,b.y,'purple');if(boss.hp<=0)killBoss();}else if(!boss){for(let j=enemies.length-1;j>=0;j--){if(distSq(b,enemies[j])<1600){enemies[j].hp-=b.dmg;h=true;if(enemies[j].hp<=0){killEnemy(enemies[j]);enemies.splice(j,1);}break;}}}if(h)bullets.splice(i,1);}if(b.y<-50||b.y>height+50)bullets.splice(i,1);}
    for(let i=enemies.length-1;i>=0;i--){if(!enemies[i].update()){enemies.splice(i,1);continue;}enemies[i].draw();if(distSq(enemies[i],player)<2500){hitPlayer();spawnParticles(enemies[i].x,enemies[i].y,'red');enemies.splice(i,1);}}
    
    // Items with Cleanup
    for(let i=items.length-1;i>=0;i--){let it=items[i];it.y+=3;if(it.type===3){ctx.fillStyle='#ff3300';ctx.shadowBlur=15;ctx.shadowColor='red';ctx.beginPath();ctx.arc(it.x,it.y,12,0,Math.PI*2);ctx.fill();ctx.fillStyle='#fff';ctx.font='bold 16px Arial';ctx.fillText('‚ö°',it.x-6,it.y+6);ctx.shadowBlur=0;}else{ctx.fillStyle=it.type===0?'gold':(it.type===1?'lime':'cyan');ctx.beginPath();ctx.arc(it.x,it.y,10,0,Math.PI*2);ctx.fill();ctx.fillStyle='#000';ctx.font='bold 12px Arial';ctx.fillText(it.type===0?'$':(it.type===1?'+':'S'),it.x-4,it.y+4);}if(distSq(it,player)<1600){if(it.type===0){Data.coins++;spawnFloatText(it.x,it.y,"+COIN");}if(it.type===1){player.hp=Math.min(3,player.hp+1);spawnFloatText(it.x,it.y,"HP UP","lime");}if(it.type===2){player.shieldTimer=300;spawnFloatText(it.x,it.y,"SHIELD","cyan");}if(it.type===3){player.upgrade();}items.splice(i,1);UI.updateScore();}else if(it.y>height+50)items.splice(i,1);}
    
    for(let i=particles.length-1;i>=0;i--){let p=particles[i];p.life-=0.05;p.x+=p.vx;p.y+=p.vy;if(p.life<=0)particles.splice(i,1);else{ctx.globalAlpha=p.life;ctx.fillStyle=p.color;ctx.fillRect(p.x,p.y,4,4);ctx.globalAlpha=1;}}
    if(shake>0)ctx.restore();
}

function hitPlayer(){if(player.shieldTimer>0)return;player.hp--;shake=20;UI.updateScore();spawnFloatText(player.x,player.y,"-1 HP","red");if(Data.settings.vib)navigator.vibrate(300);if(player.hp<=0){state='OVER';AUDIO.bgm.pause();UI.showEndScreen(false);}}
function killEnemy(e){
    spawnParticles(e.x,e.y,'orange');kills++;score+=10;UI.updateScore();spawnFloatText(e.x,e.y,"+10");
    if(Data.settings.sfx){let s=AUDIO.explo.cloneNode();s.volume=1.0;s.play().catch(()=>{});}
    let dropChance=Math.min(0.6,0.2+(level*0.008));
    if(Math.random()<dropChance){let r=Math.random();let t=0;let pc=Math.min(0.40,0.10+(level*0.006));if(r<pc)t=3;else if(r<pc+0.15)t=1;else if(r<pc+0.25)t=2;items.push({x:e.x,y:e.y,type:t});}
}
function killBoss(){shake=30;spawnParticles(boss.x,boss.y,'white');score+=1000*level;spawnFloatText(boss.x,boss.y,"+1000","#00ffff");if(Data.settings.sfx){AUDIO.explo.volume=1.0;AUDIO.explo.play().catch(()=>{});}if(level===Data.maxLevel){Data.maxLevel++;Data.save();}state='OVER';UI.showEndScreen(true);}
function useBomb(){if(bomb>0&&state==='PLAY'){bomb--;document.getElementById('bombBtn').style.display='none';enemies=[];bullets=[];if(boss)boss.hp-=100;shake=40;ctx.fillStyle='white';ctx.fillRect(0,0,width,height);spawnFloatText(width/2,height/2,"BOOM!","red");}}document.getElementById('bombBtn').onclick=useBomb;

// --- FORCE AD SYSTEM (Link Click Fix) ---
const AdSystem = {
    triggerAdAndAction: (action) => {
        // 1. Save state
        const saveData = {
            action: action, level: level, score: score, kills: kills,
            power: player ? player.powerLevel : 1,
            bossHp: boss ? boss.hp : null, bossMax: boss ? boss.maxHp : null
        };
        localStorage.setItem(RESUME_KEY, JSON.stringify(saveData));
        
        // 2. FORCE NAVIGATION (Simulate Link Click)
        // This is the strongest method for WebView to detect page change
        let dummyLink = document.createElement('a');
        dummyLink.href = window.location.href.split('?')[0] + "?t=" + new Date().getTime();
        dummyLink.style.display = 'none';
        document.body.appendChild(dummyLink);
        dummyLink.click();
    }
};

const UI={
    updateScore:()=>{document.getElementById('scoreVal').innerText=score;document.getElementById('coinVal').innerText=Data.coins;document.getElementById('hpVal').innerText="‚ù§".repeat(Math.max(0,player?player.hp:0));document.getElementById('taskVal').innerText=`${kills}/${targetKills}`;},
    updateBossHp:(c,m)=>document.getElementById('bossHpFill').style.width=Math.max(0,(c/m)*100)+"%",
    updatePowerBars:()=>{if(!player)return;const b=document.querySelectorAll('.power-bar');b.forEach((e,i)=>{if(i<player.powerLevel)e.classList.add('active');else e.classList.remove('active');});},
    showEndScreen:(v)=>{
        document.getElementById('endScreen').classList.remove('hidden');document.getElementById('hud').style.display='none';document.getElementById('bombBtn').style.display='none';document.getElementById('bossHud').style.display='none';document.getElementById('endScore').innerText="Score: "+score;
        const t=document.getElementById('endTitle');const c=document.getElementById('endButtons');c.innerHTML='';
        if(v){t.innerText="MISSION COMPLETE";t.style.color="#00ff00";c.innerHTML+=`<div class="btn btn-ad" onclick="AdSystem.triggerAdAndAction('nextLevel')">NEXT LEVEL (AD) ‚ñ∂</div>`;}
        else{t.innerText="GAME OVER";t.style.color="#ff0000";c.innerHTML+=`<div class="btn btn-ad" onclick="AdSystem.triggerAdAndAction('revive')">REVIVE (AD) ‚Ü∫</div>`;}
        if(!v)c.innerHTML+=`<div class="btn" onclick="Game.restartLevel()">RETRY</div>`;c.innerHTML+=`<div class="btn" onclick="UI.showLevelSelect()">LEVELS</div>`;c.innerHTML+=`<div class="btn" onclick="UI.goHome()">MENU</div>`;},
    goHome:()=>{state='MENU';AUDIO.bgm.pause();document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));document.getElementById('mainMenu').classList.remove('hidden');document.getElementById('ui-layer').querySelectorAll('div').forEach(d=>{if(!d.classList.contains('screen'))d.style.display='none';});UI.updateShipSelector();},
    showLevelSelect:()=>{document.getElementById('mainMenu').classList.add('hidden');document.getElementById('endScreen').classList.add('hidden');document.getElementById('levelScreen').classList.remove('hidden');const g=document.getElementById('levelGrid');g.innerHTML='';for(let i=1;i<=50;i++){let d=document.createElement('div');d.className=`level-box ${i>Data.maxLevel?'locked':''}`;d.innerText=i;d.onclick=()=>{if(i<=Data.maxLevel)Game.start(i);};g.appendChild(d);}},
    showShop:()=>{document.getElementById('mainMenu').classList.add('hidden');document.getElementById('shopScreen').classList.remove('hidden');document.getElementById('shopCoins').innerText=Data.coins;const g=document.getElementById('shopItems');g.innerHTML=`<div class="level-box" onclick="Game.buyDmg()">WEAPON DMG+<br><small>Lvl ${Data.dmgLvl}</small><br><span style="color:gold">$${500*Data.dmgLvl}</span></div>`;['plane1.png','plane2.png','plane3.png'].forEach((s,i)=>{if(!Data.unlockedShips.includes(i))g.innerHTML+=`<div class="level-box" onclick="Game.buyShip(${i})"><img src="${s}" width="30"><br>SHIP ${i+1}<br><span style="color:gold">$${1000*(i+1)}</span></div>`;});},
    showSettings:()=>{document.getElementById('mainMenu').classList.add('hidden');document.getElementById('settingScreen').classList.remove('hidden');UI.updateSettingsUI();},
    updateSettingsUI:()=>{let s=Data.settings;document.getElementById('optMusic').style.color=s.music?"gold":"gray";document.getElementById('optSfx').style.color=s.sfx?"gold":"gray";document.getElementById('optVibe').style.color=s.vib?"gold":"gray";},
    updateShipSelector:()=>{const d=document.getElementById('shipSelector');d.innerHTML='';ASSETS.planes.forEach((s,i)=>{if(Data.unlockedShips.includes(i)){let v=document.createElement('div');v.className=`ship-card ${Data.selectedShip===i?'selected':''}`;v.innerHTML=`<img src="${s}">`;v.onclick=()=>{Data.selectedShip=i;Data.save();UI.updateShipSelector();};d.appendChild(v);}});}
};

const Game={
    start:(l)=>{level=l;score=0;kills=0;if(l<=5)targetKills=10+(l*2);else targetKills=20+(l*4);bomb=1;boss=null;bullets=[];enemies=[];items=[];particles=[];player=new Player();state='PLAY';document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));document.getElementById('hud').style.display='flex';document.getElementById('bombBtn').style.display='flex';document.getElementById('levelVal').innerText=level;UI.updatePowerBars();if(Data.settings.music){AUDIO.bgm.currentTime=0;AUDIO.bgm.play().catch(()=>{});}UI.updateScore();},
    restartLevel:()=>Game.start(level),
    revive:(instant=false)=>{if(!player)player=new Player();player.hp=3;player.shieldTimer=300;if(!boss)enemies=[];bullets=[];state='PLAY';if(Data.settings.music)AUDIO.bgm.play().catch(()=>{});document.getElementById('endScreen').classList.add('hidden');document.getElementById('hud').style.display='flex';document.getElementById('bombBtn').style.display='flex';if(boss)document.getElementById('bossHud').style.display='block';input.active=false;UI.updateScore();UI.updatePowerBars();},
    nextLevel:()=>Game.start(level+1),
    buyDmg:()=>{if(Data.coins>=500*Data.dmgLvl){Data.coins-=500*Data.dmgLvl;Data.dmgLvl++;Data.save();UI.showShop();}},
    buyShip:(id)=>{if(Data.coins>=1000*(id+1)){Data.coins-=1000*(id+1);Data.unlockedShips.push(id);Data.save();UI.showShop();}},
    toggleAudio:(k)=>{Data.settings[k]=!Data.settings[k];Data.save();UI.updateSettingsUI();if(k==='music'&&!Data.settings.music)AUDIO.bgm.pause();}
};

init();
</script>
</body>
</html>
